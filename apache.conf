# Apache configuration for Next.js production deployment
# Save this as /etc/apache2/sites-available/monsbah.com.conf

<VirtualHost *:80>
    ServerName monsbah.com
    ServerAlias www.monsbah.com
    
    # Redirect HTTP to HTTPS
    Redirect permanent / https://monsbah.com/
</VirtualHost>

<VirtualHost *:443>
    ServerName monsbah.com
    ServerAlias www.monsbah.com
    
    # SSL Configuration (update paths to your certificates)
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/monsbah.com.crt
    SSLCertificateKeyFile /etc/ssl/private/monsbah.com.key
    SSLCertificateChainFile /etc/ssl/certs/monsbah.com.ca-bundle
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/monsbah-error.log
    CustomLog ${APACHE_LOG_DIR}/monsbah-access.log combined
    
    # Document root (for static files)
    DocumentRoot /var/www/monsbah
    
    # Enable required modules
    # Run: a2enmod proxy proxy_http proxy_wstunnel rewrite headers
    
    # Allow encoded slashes and special characters (CRITICAL FIX)
    AllowEncodedSlashes NoDecode
    
    # Proxy settings
    ProxyPreserveHost On
    ProxyPass /_next/static !
    ProxyPass /public !
    ProxyPass / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/
    
    # Static files from .next build
    <Directory "/var/www/monsbah/.next/static">
        Require all granted
        Options -Indexes +FollowSymLinks
        AllowOverride None
        
        # Cache static files for 1 year
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresDefault "access plus 1 year"
        </IfModule>
        
        <IfModule mod_headers.c>
            Header set Cache-Control "public, immutable"
        </IfModule>
    </Directory>
    
    # Public directory
    <Directory "/var/www/monsbah/public">
        Require all granted
        Options -Indexes +FollowSymLinks
        AllowOverride None
        
        # Cache public files for 30 days
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresDefault "access plus 30 days"
        </IfModule>
    </Directory>
    
    # Enable compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>
    
    # Rewrite rules for Next.js
    <IfModule mod_rewrite.c>
        RewriteEngine On
        
        # Allow encoded brackets in URLs (CRITICAL FIX)
        RewriteCond %{REQUEST_URI} ^/_next/
        RewriteRule .* - [NE,L]
        
        # Serve static files directly
        RewriteCond %{REQUEST_URI} ^/_next/static/
        RewriteRule ^_next/static/(.*)$ /var/www/monsbah/.next/static/$1 [L]
        
        RewriteCond %{REQUEST_URI} ^/public/
        RewriteRule ^public/(.*)$ /var/www/monsbah/public/$1 [L]
    </IfModule>
</VirtualHost>
