# Sitemap System Architecture Diagram

## System Flow Visualization

```
┌─────────────────────────────────────────────────────────────────────┐
│                         SITEMAP REQUEST                              │
│              (e.g., /kw-ar/products/sitemap-v2?id=0)                │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                                 ▼
                    ┌────────────────────────┐
                    │  Check Cache Exists?   │
                    └─────────┬──────────────┘
                              │
                 ┌────────────┴────────────┐
                 │                         │
                 ▼ NO                      ▼ YES
    ┌───────────────────────┐   ┌──────────────────────┐
    │  FIRST TIME FLOW      │   │   Check Cache Age?   │
    │  (Cold Start)         │   └──────┬───────────────┘
    └───────────┬───────────┘          │
                │              ┌────────┴────────┐
                │              │                 │
                │              ▼ FRESH           ▼ EXPIRED
                │   ┌────────────────────┐   ┌───────────────────┐
                │   │  CACHED FLOW       │   │  UPDATE FLOW      │
                │   │  (Hot Path)        │   │  (Incremental)    │
                │   └────────┬───────────┘   └─────────┬─────────┘
                │            │                         │
                ▼            ▼                         ▼
```

## FLOW 1: First Time (No Cache)

```
┌─────────────────────────────────────────────────────────────┐
│  STEP 1: Fetch All Data from Database/API                   │
│  ┌────────────────────────────────────────────┐            │
│  │  • Query all products (paginated)          │            │
│  │  • May take 30-60 seconds for large sets   │            │
│  │  • Example: 150,000 products fetched       │            │
│  └────────────────────────────────────────────┘            │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  STEP 2: Convert to Sitemap Entries                         │
│  ┌────────────────────────────────────────────┐            │
│  │  Transform each product to:                │            │
│  │  {                                         │            │
│  │    url: "https://monsbah.com/...",        │            │
│  │    lastModified: "2024-10-06...",         │            │
│  │    changeFrequency: "weekly",             │            │
│  │    priority: 0.8                          │            │
│  │  }                                         │            │
│  └────────────────────────────────────────────┘            │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  STEP 3: Intelligent Chunking                               │
│  ┌────────────────────────────────────────────┐            │
│  │  Split into chunks based on limits:        │            │
│  │  • Max 50,000 URLs per chunk               │            │
│  │  • Max 50 MB per chunk                     │            │
│  │                                            │            │
│  │  Example: 150,000 URLs → 3 chunks:        │            │
│  │  ├─ Chunk 0: 50,000 URLs (8.2 MB)        │            │
│  │  ├─ Chunk 1: 50,000 URLs (8.1 MB)        │            │
│  │  └─ Chunk 2: 50,000 URLs (8.3 MB)        │            │
│  └────────────────────────────────────────────┘            │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  STEP 4: Save to Cache                                      │
│  ┌────────────────────────────────────────────┐            │
│  │  File: .sitemap-cache/products-kw-ar.json  │            │
│  │  {                                         │            │
│  │    chunks: [[...], [...], [...]],         │            │
│  │    stats: { totalUrls: 150000, ... },     │            │
│  │    lastGenerated: "2024-10-06T10:00:00Z"  │            │
│  │  }                                         │            │
│  └────────────────────────────────────────────┘            │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  STEP 5: Return Requested Chunk                             │
│  ┌────────────────────────────────────────────┐            │
│  │  User requested: ?id=0                     │            │
│  │  Return: Chunk 0 with 50,000 URLs         │            │
│  │  Format: XML sitemap                       │            │
│  └────────────────────────────────────────────┘            │
└─────────────────────────────────────────────────────────────┘
```

## FLOW 2: Cached Request (Fast Path)

```
┌─────────────────────────────────────────────────────────────┐
│  User Request: /kw-ar/products/sitemap-v2?id=0             │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Load Cache File (Instant - 50ms)                          │
│  ┌────────────────────────────────────────────┐            │
│  │  Read: .sitemap-cache/products-kw-ar.json  │            │
│  │  Parse JSON                                │            │
│  │  Extract chunk [0]                         │            │
│  └────────────────────────────────────────────┘            │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Generate XML from Cache                                    │
│  ┌────────────────────────────────────────────┐            │
│  │  Convert chunk entries to XML              │            │
│  │  Add proper headers                        │            │
│  │  Total time: ~50-200ms                     │            │
│  └────────────────────────────────────────────┘            │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Return to User (FAST! 🚀)                                  │
└─────────────────────────────────────────────────────────────┘
```

## FLOW 3: Incremental Update (Smart Path)

```
┌─────────────────────────────────────────────────────────────┐
│  Cache Expired (> 6 hours old)                              │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  PARALLEL OPERATIONS                                         │
│  ┌─────────────────────┐  ┌─────────────────────┐          │
│  │ Load Old Cache      │  │ Fetch New Data      │          │
│  │ (from disk)         │  │ (from API)          │          │
│  └──────────┬──────────┘  └──────────┬──────────┘          │
│             │                         │                      │
│             └────────────┬────────────┘                      │
└──────────────────────────┼──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Detect Changes (Smart Diff)                                │
│  ┌────────────────────────────────────────────┐            │
│  │  Compare Old vs New URLs                   │            │
│  │                                            │            │
│  │  Result:                                   │            │
│  │  • Added:   250 new products               │            │
│  │  • Updated: 150 modified products          │            │
│  │  • Deleted: 50 removed products            │            │
│  │  • Unchanged: 149,550 products             │            │
│  │                                            │            │
│  │  Total processing: Only 450 changes!       │            │
│  │  vs 150,000 full regeneration              │            │
│  └────────────────────────────────────────────┘            │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Merge Changes (Efficient Update)                           │
│  ┌────────────────────────────────────────────┐            │
│  │  1. Remove deleted URLs                    │            │
│  │  2. Update modified URLs                   │            │
│  │  3. Add new URLs                           │            │
│  │  4. Re-sort all entries                    │            │
│  │  5. Re-chunk if needed                     │            │
│  │                                            │            │
│  │  Result: Updated chunks maintaining        │            │
│  │  50K/50MB limits                           │            │
│  └────────────────────────────────────────────┘            │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Save Updated Cache                                         │
│  ┌────────────────────────────────────────────┐            │
│  │  Overwrite: products-kw-ar.json            │            │
│  │  Update: lastGenerated timestamp           │            │
│  │  New stats calculated                      │            │
│  └────────────────────────────────────────────┘            │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Return Requested Chunk                                     │
└─────────────────────────────────────────────────────────────┘
```

## Chunking Logic Example

```
Input: 175,000 Products
│
├─ Calculate size of each entry (~170 bytes average)
├─ Determine optimal chunk size
│
Result: 4 Chunks
├─ Chunk 0: Products   1 -  50,000 (8.5 MB) ✓
├─ Chunk 1: Products  50,001 - 100,000 (8.5 MB) ✓
├─ Chunk 2: Products 100,001 - 150,000 (8.5 MB) ✓
└─ Chunk 3: Products 150,001 - 175,000 (4.25 MB) ✓

All chunks within limits:
✓ Each < 50,000 URLs
✓ Each < 50 MB
```

## Cache Management API Flow

```
┌─────────────────────────────────────────────────────────────┐
│  GET /api/sitemap/invalidate                                │
│  (Get cache statistics)                                     │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Scan Cache Directory                                       │
│  ┌────────────────────────────────────────────┐            │
│  │  .sitemap-cache/                           │            │
│  │  ├─ products-kw-ar.json (12.5 MB)         │            │
│  │  ├─ products-sa-ar.json (15.2 MB)         │            │
│  │  ├─ blogs-kw-ar.json (0.8 MB)             │            │
│  │  └─ companies-kw-ar.json (2.1 MB)         │            │
│  │                                            │            │
│  │  Total: 30.6 MB, 4 files                  │            │
│  └────────────────────────────────────────────┘            │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Return Statistics JSON                                     │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  POST /api/sitemap/invalidate                               │
│  { type: "products", locale: "kw-ar" }                      │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Delete Matching Cache Files                                │
│  ┌────────────────────────────────────────────┐            │
│  │  Deleted: products-kw-ar.json              │            │
│  │  Next request will regenerate              │            │
│  └────────────────────────────────────────────┘            │
└─────────────────────────────────────────────────────────────┘
```

## Performance Comparison

```
SCENARIO: 100,000 Product Sitemap

WITHOUT CACHING (Old System):
┌──────────────────────────────────┐
│  Every Request:                  │
│  1. Fetch 100K products: 45s     │
│  2. Process data: 8s             │
│  3. Generate XML: 5s             │
│  ─────────────────────────────   │
│  Total: 58 seconds               │
│  Database load: HIGH             │
└──────────────────────────────────┘

WITH INTELLIGENT CACHING (New System):
┌──────────────────────────────────┐
│  First Request:                  │
│  Same as above: 58 seconds       │
│  ─────────────────────────────   │
│  Cached Requests (99% of time):  │
│  1. Load from disk: 0.05s        │
│  2. Parse JSON: 0.02s            │
│  3. Generate XML: 0.03s          │
│  ─────────────────────────────   │
│  Total: 0.1 seconds (100ms)      │
│  Database load: NONE             │
│  ═════════════════════════════   │
│  Performance: 580x FASTER! 🚀    │
└──────────────────────────────────┘
```

## Monitoring Dashboard (Conceptual)

```
╔══════════════════════════════════════════════════════════════╗
║             SITEMAP CACHE DASHBOARD                          ║
╠══════════════════════════════════════════════════════════════╣
║  Cache Health: ████████████████░░ 85% Healthy               ║
║                                                              ║
║  ┌────────────────┬──────────┬──────────┬─────────────────┐ ║
║  │ Type           │ Locale   │ URLs     │ Last Update     │ ║
║  ├────────────────┼──────────┼──────────┼─────────────────┤ ║
║  │ Products       │ kw-ar    │ 125,000  │ 2h ago ✓       │ ║
║  │ Products       │ sa-ar    │ 98,000   │ 5h ago ✓       │ ║
║  │ Blogs          │ kw-ar    │ 1,250    │ 8h ago ⚠       │ ║
║  │ Companies      │ kw-ar    │ 5,600    │ 1h ago ✓       │ ║
║  └────────────────┴──────────┴──────────┴─────────────────┘ ║
║                                                              ║
║  Total Cached URLs: 229,850                                 ║
║  Total Cache Size: 42.3 MB                                  ║
║  Cache Hit Rate: 98.7%                                      ║
║  Avg Response Time: 95ms                                    ║
╚══════════════════════════════════════════════════════════════╝
```

This visual guide helps understand the intelligent sitemap system! 🎨
